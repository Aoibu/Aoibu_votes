<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>تصويت أفضل الشخصيات النسائية في كونان</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">

<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<style>
body, header, .container, .section-title, .hint, .card, .info, .title, .subtitle, .pickline, .actions, footer {
  font-family: 'Almarai', sans-serif !important;
}
body {margin:0; background:linear-gradient(135deg,#0f2027,#203a43,#2c5364); color:#f1f1f1;}
header {background-color:#111; padding:20px; text-align:center; font-size:28px; font-weight:700; color:#ff7ad9; border-bottom:3px solid #f06292;}
.container {max-width:1100px; margin:auto; padding:20px;}
.section-title {font-size:24px; margin:40px 0 12px; border-right:5px solid #f06292; padding-right:10px;}
.grid {display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:14px;}
.card {background-color:#1e1e1e; border:1px solid #333; border-radius:10px; overflow:hidden; display:flex; flex-direction:column; transition:transform .25s, box-shadow .25s; position:relative;}
.card:hover {transform:translateY(-4px); box-shadow:0 8px 18px rgba(0,0,0,.35);}
.poster-wrap {background:#0d1b22; aspect-ratio:2/3; display:grid; place-items:center; overflow:hidden;}
.poster {width:100%; height:100%; object-fit:cover;}
.fallback {width:100%; height:100%; display:grid; place-items:center; font-size:14px; color:#ffcce7; padding:8px; text-align:center;}
.info {padding:10px 12px; display:grid; gap:8px;}
.title {font-weight:700; color:#ff7ad9; font-size:16px; line-height:1.4;}
.subtitle {font-size:12px; color:#ffb6d3;}
.pickline {display:flex; align-items:center; gap:8px;}
.pickline input {transform:scale(1.2);}
.actions {display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:18px;}
button {background:#f06292; color:#fff; border:0; font-weight:700; padding:10px 18px; border-radius:8px; cursor:pointer; transition:transform .2s;}
button:hover {transform:translateY(-2px);}
button:disabled {opacity:.55; cursor:not-allowed;}
.status {font-size:14px; color:#ffcce7; min-height:22px; margin-top:8px;}
#captchaContainer {display:none; margin-top:15px;}
</style>
</head>
<body>
<header>تصويت أفضل الشخصيات النسائية في المحقق كونان</header>
<div class="container">
  <div class="section-title">اختر حتى 3 شخصيات فقط</div>

  <form id="voteForm">
    <input type="hidden" id="choicesField"/>
    <div id="grid" class="grid" aria-live="polite"></div>

    <div class="actions">
      <button id="voteBtn" type="button">إرسال تصويتي</button>
      <button id="clearBtn" type="button" disabled>مسح الاختيارات</button>
      <span id="pickedInfo"></span>
    </div>

    <div id="captchaContainer">
      <div class="cf-turnstile" data-sitekey="0x4AAAAAABupN3GWUO1WU331"></div>
    </div>

    <div class="status" id="status"></div>
  </form>

  <footer>Aoibu • صور من ويكيبيديا.</footer>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxFNCcSwx2c30Cv5kebDbSaiQwseXarL3uTdKH-LpTACsX2pgZDGE7p73sxb1LAO7ld7w/exec";
const SHEET_URL = "https://opensheet.elk.sh/11MQYWmFykMjljqJqKIeTNBt-49mVW109NaCi2hLIZpg/1";

const grid = document.getElementById('grid');
const voteBtn = document.getElementById('voteBtn');
const clearBtn = document.getElementById('clearBtn');
const captchaContainer = document.getElementById('captchaContainer');
const statusEl = document.getElementById('status');
const pickedInfo = document.getElementById('pickedInfo');
const choicesField = document.getElementById('choicesField');

let selected = new Set();
let CHARACTERS = [];

function updateUIState(){
  voteBtn.disabled = selected.size === 0 || selected.size > 3;
  clearBtn.disabled = selected.size === 0;
  pickedInfo.textContent = `المختار: ${selected.size} / 3`;
  const arr = Array.from(selected).map(num=>{
    const item = CHARACTERS.find(m=>m.n==num);
    return `${num}. ${item?.name || ''}`;
  });
  choicesField.value = arr.join(' | ');
}

function flash(msg, ms=2000){
  statusEl.textContent = msg;
  if(ms) setTimeout(()=>statusEl.textContent='', ms);
}

async function fetchPoster(wikiEn){
  if(!wikiEn) return null;
  const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(wikiEn)}`;
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error('bad status');
    const data = await res.json();
    return data?.thumbnail?.source || data?.originalimage?.source || null;
  }catch(e){ return null; }
}

function cardTemplate({n,name,wikiEn}){
  const card=document.createElement('div'); card.className='card';
  const posterWrap=document.createElement('div'); posterWrap.className='poster-wrap';
  const img=document.createElement('img'); img.className='poster'; img.alt=name; img.loading='lazy';
  const fallback=document.createElement('div'); fallback.className='fallback'; fallback.textContent='جاري تحميل الصورة…';
  posterWrap.appendChild(fallback);

  const info=document.createElement('div'); info.className='info';
  const title=document.createElement('div'); title.className='title'; title.textContent=`${n}. ${name}`;
  const sub=document.createElement('div'); sub.className='subtitle'; sub.textContent= wikiEn ? `Wikipedia: ${wikiEn.replaceAll('_',' ')}` : '';
  const pickline=document.createElement('label'); pickline.className='pickline';
  const checkbox=document.createElement('input'); checkbox.type='checkbox'; checkbox.value=n;
  checkbox.addEventListener('change', ()=>{
    if(checkbox.checked){
      if(selected.size >=3){ checkbox.checked=false; flash('مسموح بحد أقصى 3 شخصيات فقط ✅',2200); return;}
      selected.add(n);
    }else{ selected.delete(n);}
    updateUIState();
  });
  const pickText=document.createElement('span'); pickText.textContent='اختيار هذه الشخصية';
  pickline.appendChild(checkbox); pickline.appendChild(pickText);

  info.appendChild(title); info.appendChild(sub); info.appendChild(pickline);
  card.appendChild(posterWrap); card.appendChild(info);

  fetchPoster(wikiEn).then(src=>{
    if(src){ img.src=src; posterWrap.innerHTML=''; posterWrap.appendChild(img);}
    else{ fallback.textContent='لا توجد صورة متاحة'; }
  });
  return card;
}

async function loadCharacters(){
  try{
    const res = await fetch(SHEET_URL);
    const data = await res.json();
    CHARACTERS = data.map((row,i)=>({n:i+1, name:row["الاسم"], wikiEn:row["wikiEn"] || ""}));
    CHARACTERS.forEach(ch => grid.appendChild(cardTemplate(ch)));
  }catch(e){ flash("❌ فشل تحميل الشخصيات من شيتس",4000); }
}

clearBtn.addEventListener('click', ()=>{
  selected.clear();
  document.querySelectorAll('.pickline input[type="checkbox"]').forEach(ch=>ch.checked=false);
  updateUIState();
});

voteBtn.addEventListener('click', ()=>{
  if(selected.size===0){ flash('❌ اختر شخصية واحدة على الأقل'); return; }
  captchaContainer.style.display='block';
  window.scrollTo({top:captchaContainer.offsetTop-20, behavior:'smooth'});
});

window.turnstileCallback = async function(token){
  const checked = Array.from(document.querySelectorAll('input[name="choices"]:checked')).map(c=>c.value);
  const formData = new FormData();
  formData.append("choices", checked.join(" | "));
  formData.append("ip", (await fetch("https://api.ipify.org?format=json").then(r=>r.json())).ip);
  formData.append("cf-turnstile-response", token);

  try {
    const res = await fetch(SCRIPT_URL, {method:"POST", body:formData});
    const text = await res.text();
    flash('✅ تم إرسال تصويتك بنجاح!',3000);
    selected.clear();
    document.querySelectorAll('.pickline input').forEach(ch=>ch.checked=false);
    updateUIState();
    captchaContainer.style.display='none';
  } catch(err) { flash('❌ حدث خطأ أثناء الإرسال',3000); }
};

updateUIState();
loadCharacters();
</script>
</body>
</html>
